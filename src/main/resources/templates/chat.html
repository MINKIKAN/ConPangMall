<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Room</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js" integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js" integrity="sha512-1QvjE7BtotQjkq8PxLeF6P46gEpBRXuskzIVgjFpekzFVF4yjRgrQvTG1MTOJ3yQgvTteKAcO7DSZI92+u/yZw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        .send_btn {
            color: #fff;
            background: #0acf97;
            border:1px solid #0acf97;
        }
        .send_btn:hover {
            color:#fff;
            background: #09b080;
            border: 1px solid #08a679;
        }
    </style>
</head>
<body>

<div>
    <h1>Chat Room - Room ID: <span th:text="${roomId}"></span></h1>
    <ul id="chatLog">
        <p th:each="cm : ${list}" th:text="${cm.getContent()}"></p>
    </ul>
</div>

<div>
    <form id="messageForm">
        <input type="text" id="message" name="message">
        <button type="submit" class="send_btn">Send</button>
    </form>
</div>

<script type="text/javascript" th:inline="javascript">
    $(document).ready(function () {
        let roomId = /*[[${roomId}]]*/ '';
        let memberId = /*[[${memberId}]]*/ '';
        let socket = new SockJS('/ws');
        let stompClient = Stomp.over(socket);
        function showMessage(message) {
            let chatLog = $('#chatLog');
            let messageString = message.senderId + ' : ' + message.content;
            let messageElement = $('<p>').text(messageString);
            chatLog.append(messageElement);
        }

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/chatting/' + roomId, function (message) {
                showMessage(JSON.parse(message.body));
            });
        });


        $('#messageForm').on('submit', function (e) {
            e.preventDefault();
            let message = $('#message').val();
            if (message) {
                stompClient.send('/app/chatting/' + roomId, {}, JSON.stringify({
                    'content': message,
                    'senderId': memberId
                }));
                $('#message').val('');
            }
        });
    });
</script>

</body>
</html>

